!(function (e, t) {
  "object" == typeof exports && "undefined" != typeof module
    ? (module.exports = t())
    : "function" == typeof define && define.amd
    ? define(t)
    : ((e =
        "undefined" != typeof globalThis ? globalThis : e || self).ImageKit =
        t());
})(this, function () {
  "use strict";
  function e(t) {
    return (e =
      "function" == typeof Symbol && "symbol" == typeof Symbol.iterator
        ? function (e) {
            return typeof e;
          }
        : function (e) {
            return e &&
              "function" == typeof Symbol &&
              e.constructor === Symbol &&
              e !== Symbol.prototype
              ? "symbol"
              : typeof e;
          })(t);
  }
  function t(e, t) {
    for (var r = 0; r < t.length; r++) {
      var n = t[r];
      (n.enumerable = n.enumerable || !1),
        (n.configurable = !0),
        "value" in n && (n.writable = !0),
        Object.defineProperty(e, n.key, n);
    }
  }
  function r(e, t, r) {
    return (
      t in e
        ? Object.defineProperty(e, t, {
            value: r,
            enumerable: !0,
            configurable: !0,
            writable: !0,
          })
        : (e[t] = r),
      e
    );
  }
  function n(e, t) {
    var r = Object.keys(e);
    if (Object.getOwnPropertySymbols) {
      var n = Object.getOwnPropertySymbols(e);
      t &&
        (n = n.filter(function (t) {
          return Object.getOwnPropertyDescriptor(e, t).enumerable;
        })),
        r.push.apply(r, n);
    }
    return r;
  }
  function o(e) {
    for (var t = 1; t < arguments.length; t++) {
      var o = null != arguments[t] ? arguments[t] : {};
      t % 2
        ? n(Object(o), !0).forEach(function (t) {
            r(e, t, o[t]);
          })
        : Object.getOwnPropertyDescriptors
        ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(o))
        : n(Object(o)).forEach(function (t) {
            Object.defineProperty(e, t, Object.getOwnPropertyDescriptor(o, t));
          });
    }
    return e;
  }
  function a(e, t) {
    (null == t || t > e.length) && (t = e.length);
    for (var r = 0, n = new Array(t); r < t; r++) n[r] = e[r];
    return n;
  }
  function i(e, t) {
    var r;
    if ("undefined" == typeof Symbol || null == e[Symbol.iterator]) {
      if (
        Array.isArray(e) ||
        (r = (function (e, t) {
          if (e) {
            if ("string" == typeof e) return a(e, t);
            var r = Object.prototype.toString.call(e).slice(8, -1);
            return (
              "Object" === r && e.constructor && (r = e.constructor.name),
              "Map" === r || "Set" === r
                ? Array.from(e)
                : "Arguments" === r ||
                  /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)
                ? a(e, t)
                : void 0
            );
          }
        })(e)) ||
        (t && e && "number" == typeof e.length)
      ) {
        r && (e = r);
        var n = 0,
          o = function () {};
        return {
          s: o,
          n: function () {
            return n >= e.length ? { done: !0 } : { done: !1, value: e[n++] };
          },
          e: function (e) {
            throw e;
          },
          f: o,
        };
      }
      throw new TypeError(
        "Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."
      );
    }
    var i,
      s = !0,
      u = !1;
    return {
      s: function () {
        r = e[Symbol.iterator]();
      },
      n: function () {
        var e = r.next();
        return (s = e.done), e;
      },
      e: function (e) {
        (u = !0), (i = e);
      },
      f: function () {
        try {
          s || null == r.return || r.return();
        } finally {
          if (u) throw i;
        }
      },
    };
  }
  var s = {
      message: "Missing urlEndpoint during SDK initialization",
      help: "",
    },
    u = { message: "Invalid transformationPosition parameter", help: "" },
    f = { message: "Missing file parameter for upload", help: "" },
    p = { message: "Missing fileName parameter for upload", help: "" },
    l = { message: "Missing public key for upload", help: "" },
    c = {
      message:
        "Request to ImageKit upload endpoint failed due to network error",
      help: "",
    },
    d = { message: "Invalid uploadOptions parameter", help: "" },
    m = {
      message:
        "Missing signature for upload. The SDK expects token, sginature and expire for authentication.",
      help: "",
    },
    y = {
      message:
        "Missing token for upload. The SDK expects token, sginature and expire for authentication.",
      help: "",
    },
    h = {
      message:
        "Missing expire for upload. The SDK expects token, sginature and expire for authentication.",
      help: "",
    },
    g = {
      message:
        "Invalid transformation parameter. Please include at least pre, post, or both.",
      help: "",
    },
    b = { message: "Invalid pre transformation parameter.", help: "" },
    v = { message: "Invalid post transformation parameter.", help: "" };
  function w(e, t, r) {
    "function" == typeof r && (e ? r(t, null) : r(null, t));
  }
  function O(e) {
    var t = {},
      r = e.getAllResponseHeaders();
    return (
      Object.keys(r).length &&
        r
          .trim()
          .split(/[\r\n]+/)
          .map(function (e) {
            return e.split(/: /);
          })
          .forEach(function (e) {
            t[e[0].trim()] = e[1].trim();
          }),
      t
    );
  }
  var j = function (e, t) {
      var r = o({}, e),
        n = { statusCode: t.status, headers: O(t) };
      return (
        Object.defineProperty(r, "$ResponseMetadata", {
          value: n,
          enumerable: !1,
          writable: !1,
        }),
        r
      );
    },
    S = function (e, t) {
      return new Promise(function (r, n) {
        e.open("POST", "https://upload.imagekit.io/api/v1/files/upload"),
          (e.onerror = function (e) {
            return n(c);
          }),
          (e.onload = function () {
            if (200 === e.status)
              try {
                var t = JSON.parse(e.responseText),
                  o = j(t, e);
                return r(o);
              } catch (e) {
                return n(e);
              }
            else
              try {
                t = JSON.parse(e.responseText);
                var a = j(t, e);
                return n(a);
              } catch (e) {
                return n(e);
              }
          }),
          e.send(t);
      });
    },
    x = function (t, r, n, o) {
      if (r.file)
        if (r.fileName)
          if (n.publicKey)
            if (r.token)
              if (r.signature)
                if (r.expire) {
                  if (r.transformation) {
                    if (
                      !Object.keys(r.transformation).includes("pre") &&
                      !Object.keys(r.transformation).includes("post")
                    )
                      return void w(!0, g, o);
                    if (
                      Object.keys(r.transformation).includes("pre") &&
                      !r.transformation.pre
                    )
                      return void w(!0, b, o);
                    if (Object.keys(r.transformation).includes("post")) {
                      if (!Array.isArray(r.transformation.post))
                        return void w(!0, v, o);
                      var a,
                        s = i(r.transformation.post);
                      try {
                        for (s.s(); !(a = s.n()).done; ) {
                          var u = a.value;
                          if ("abs" === u.type && !u.protocol && !u.value)
                            return void w(!0, v, o);
                          if ("transformation" === u.type && !u.value)
                            return void w(!0, v, o);
                        }
                      } catch (e) {
                        s.e(e);
                      } finally {
                        s.f();
                      }
                    }
                  }
                  var c,
                    d = new FormData();
                  for (c in r)
                    c &&
                      ("file" === c && "string" != typeof r.file
                        ? d.append("file", r.file, String(r.fileName))
                        : "tags" === c && Array.isArray(r.tags)
                        ? d.append("tags", r.tags.join(","))
                        : "signature" === c
                        ? d.append("signature", r.signature)
                        : "expire" === c
                        ? d.append("expire", String(r.expire))
                        : "token" === c
                        ? d.append("token", r.token)
                        : "responseFields" === c &&
                          Array.isArray(r.responseFields)
                        ? d.append("responseFields", r.responseFields.join(","))
                        : "extensions" === c && Array.isArray(r.extensions)
                        ? d.append("extensions", JSON.stringify(r.extensions))
                        : "customMetadata" !== c ||
                          "object" !== e(r.customMetadata) ||
                          Array.isArray(r.customMetadata) ||
                          null === r.customMetadata
                        ? "transformation" === c &&
                          "object" === e(r.transformation) &&
                          null !== r.transformation
                          ? d.append(c, JSON.stringify(r.transformation))
                          : void 0 !== r[c] && d.append(c, String(r[c]))
                        : d.append(
                            "customMetadata",
                            JSON.stringify(r.customMetadata)
                          ));
                  d.append("publicKey", n.publicKey),
                    (function (e, t, r) {
                      S(e, t).then(
                        function (e) {
                          return w(!1, e, r);
                        },
                        function (e) {
                          return w(!0, e, r);
                        }
                      );
                    })(t, d, o);
                } else w(!0, h, o);
              else w(!0, m, o);
            else w(!0, y, o);
          else w(!0, l, o);
        else w(!0, p, o);
      else w(!0, f, o);
    },
    P = {
      width: "w",
      height: "h",
      aspectRatio: "ar",
      quality: "q",
      crop: "c",
      cropMode: "cm",
      focus: "fo",
      x: "x",
      y: "y",
      format: "f",
      radius: "r",
      background: "bg",
      border: "b",
      rotation: "rt",
      rotate: "rt",
      blur: "bl",
      named: "n",
      progressive: "pr",
      lossless: "lo",
      trim: "t",
      metadata: "md",
      colorProfile: "cp",
      defaultImage: "di",
      dpr: "dpr",
      effectSharpen: "e-sharpen",
      effectUSM: "e-usm",
      effectContrast: "e-contrast",
      effectGray: "e-grayscale",
      original: "orig",
      effectShadow: "e-shadow",
      effectGradient: "e-gradient",
      raw: "raw",
    },
    k = ["path", "query"],
    A = function () {
      return "path";
    },
    M = function (e) {
      return "query" === e.transformationPosition;
    },
    E = function (e) {
      return (
        void 0 !== e.transformationPosition &&
        -1 != k.indexOf(e.transformationPosition)
      );
    },
    I = function (e) {
      return (e && (P[e] || P[e.toLowerCase()])) || "";
    },
    K = function () {
      return ":";
    },
    T = function () {
      return ",";
    },
    D = function () {
      return "-";
    };
  function R(e) {
    return (
      "string" == typeof e &&
        "/" == e[e.length - 1] &&
        (e = e.substring(0, e.length - 1)),
      e
    );
  }
  function q(e, t) {
    var r = t || "/",
      n = new RegExp(r + "{1,}", "g");
    return e.join(r).replace(n, r);
  }
  var N = function (e) {
    if (!e.path && !e.src) return "";
    var t, r, n;
    try {
      e.path
        ? ((n = new URL(e.urlEndpoint).pathname),
          (t = new URL(q([e.urlEndpoint.replace(n, ""), e.path]))))
        : ((t = new URL(e.src)), (r = !0));
    } catch (e) {
      return console.error(e), "";
    }
    for (var o in e.queryParameters)
      t.searchParams.append(o, String(e.queryParameters[o]));
    var a = (function (e) {
      if (!Array.isArray(e)) return "";
      for (var t = [], r = 0, n = e.length; r < n; r++) {
        var o = [];
        for (var a in e[r])
          if (void 0 !== e[r][a] && null !== e[r][a]) {
            var i = I(a);
            if ((i || (i = a), "-" === e[r][a])) o.push(i);
            else if ("raw" === a) o.push(e[r][a]);
            else {
              var s = e[r][a];
              "di" === i &&
                (s = (s = R(
                  ("string" == typeof (u = s || "") &&
                    "/" == u[0] &&
                    (u = u.slice(1)),
                  u)
                )).replace(/\//g, "@@")),
                o.push([i, s].join(D()));
            }
          }
        t.push(o.join(T()));
      }
      var u;
      return t.join(K());
    })(e.transformation);
    return (
      a &&
        a.length &&
        (M(e) || r
          ? t.searchParams.append("tr", a)
          : (t.pathname = q(["tr" + K() + a, t.pathname]))),
      (t.pathname = q(n ? [n, t.pathname] : [t.pathname])),
      t.href
    );
  };
  return (function () {
    function n(e) {
      if (
        ((function (e, t) {
          if (!(e instanceof t))
            throw new TypeError("Cannot call a class as a function");
        })(this, n),
        r(this, "options", {
          sdkVersion: "javascript-".concat("3.0.0"),
          publicKey: "",
          urlEndpoint: "",
          transformationPosition: A(),
        }),
        (this.options = o(o({}, this.options), e || {})),
        !this.options.urlEndpoint)
      )
        throw s;
      if (!E(this.options)) throw u;
    }
    var a, i, f;
    return (
      (a = n),
      (i = [
        {
          key: "url",
          value: function (e) {
            return (t = e), (r = this.options), N(o(o({}, r), t));
            var t, r;
          },
        },
        {
          key: "upload",
          value: function (t, r, n) {
            var a;
            if (
              ("function" == typeof r ? (a = r) : (n = r || {}),
              !t || "object" !== e(t))
            )
              return w(!0, d, a);
            var i = o(o({}, this.options), n),
              s = (t || {}).xhr;
            delete t.xhr;
            var u,
              f,
              p = s || new XMLHttpRequest();
            return ((u = this),
            (f = x),
            function () {
              for (
                var e = arguments.length, t = new Array(e), r = 0;
                r < e;
                r++
              )
                t[r] = arguments[r];
              if (t.length !== f.length || void 0 === t[t.length - 1])
                return new Promise(function (e, r) {
                  t.pop(),
                    t.push(function (t) {
                      if (t) return r(t);
                      for (
                        var n = arguments.length,
                          o = new Array(n > 1 ? n - 1 : 0),
                          a = 1;
                        a < n;
                        a++
                      )
                        o[a - 1] = arguments[a];
                      e(o.length > 1 ? o : o[0]);
                    }),
                    f.call.apply(f, [u].concat(t));
                });
              if ("function" != typeof t[t.length - 1])
                throw new Error("Callback must be a function.");
              f.call.apply(f, [u].concat(t));
            })(p, t, i, a);
          },
        },
      ]) && t(a.prototype, i),
      f && t(a, f),
      n
    );
  })();
});
